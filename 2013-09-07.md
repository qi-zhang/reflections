<h3>Weekly Reflections for the week 12/1-12/7</h3>

<h4>Let's Make It Even Better!</h4>

I've been making further improvements on etas-training.R this week, I focused on etas.CI function, which was widely used in this code and occupied most of running time. The definition of etas.CI functiong was

    etas.CI <- function(time,t.events,mag.events,m0,mu,K,alpha,c,p){
      mu+sum(K*10^(alpha*(mag.events-m0))/(time-t.events+c)^p)
    }

Clearly the most expensive operations were the power calculations inside sapply iterations. Considered the fact that there were close to 7,000 magnitude observations consisted of 248 different values, I decided to replace magnitude relevant power calculation with table look up. Given a dataset of N records, etas.CI need to do the power calculation roughly N*N/2 times for different records. On the other hand, considered the fact that the worst earthquake ever recorded was about magnitude 9.00. The modified version only needs to finish no more than 900 calculations to achieve the same purpose. To achieve better performance, I rewrote the whole function and made it a vectore-oriented function after review the code. Here is the implementation of new function

    etas.CI2 <- function(time_vec, events_idx, m0, mu, K, alpha, c, p) {
      min_mag=min(c(mags,m0))
      mag_power=rep(0,(max(mags)-min_mag)*100+1)
      for(i in unique(sort(mags[1:max(events_idx)]))-min_mag) {
        mag_power[100*i+1.5]=10^(alpha*(i+min_mag-m0))
      }
      sapply(c(1:length(time_vec)), function(x) {
        mu+K*sum(mag_power[100*(mags[1:events_idx[x]]-min_mag)+1.5]/
                 (time_vec[x]-times[1:events_idx[x]]+c)^p)
      })
    }

